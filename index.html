<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>·ª®ng D·ª•ng Ki·ªÉm Tra ƒê∆°n H√†ng Chuy√™n Nghi·ªáp</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap');
        :root {
            --primary-color: #0052cc; --secondary-color: #6c757d; --background-color: #f4f5f7;
            --text-color: #172b4d; --border-color: #dfe1e6; --success-color: #00875a;
            --error-color: #de350b; --white-color: #ffffff; --shadow: rgba(0, 0, 0, 0.1) 0px 4px 6px -1px, rgba(0, 0, 0, 0.06) 0px 2px 4px -1px;
            --hover-primary: #0040a0; --hover-success: #006644; --hover-error: #bf2600;
        }
        body { font-family: 'Be Vietnam Pro', sans-serif; background-color: var(--background-color); color: var(--text-color); margin: 0; padding: 24px; line-height: 1.6; }
        .container { max-width: 1400px; margin: auto; background: var(--white-color); padding: 32px; border-radius: 8px; box-shadow: var(--shadow); position: relative; }
        h1, h2, h3 { color: var(--text-color); margin-top: 0; }
        h1 { font-size: 24px; border-bottom: 2px solid var(--primary-color); padding-bottom: 12px; margin-bottom: 24px; }
        h2 { font-size: 20px; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 1px solid var(--border-color); }
        h3 { font-size: 18px; color: var(--primary-color); }
        .controls, .table-actions, .selector-wrapper { margin-bottom: 24px; display: flex; gap: 16px; align-items: center; flex-wrap: wrap; }
        .file-upload { display: flex; align-items: center; gap: 12px; padding: 12px; background: #fafbfc; border: 2px dashed var(--border-color); border-radius: 5px; cursor: pointer; transition: border-color 0.2s, background-color 0.2s; }
        .file-upload:hover { border-color: var(--primary-color); background-color: #f0f6ff;}
        label, .label { font-weight: 600; }
        input[type="file"] { display: none; }
        select, input[type="text"] { border: 2px solid var(--border-color); padding: 8px 12px; border-radius: 4px; font-size: 14px; transition: border-color 0.2s, box-shadow 0.2s; }
        select:focus, input[type="text"]:focus { border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(0, 82, 204, 0.2); outline: none;}
        button { background-color: var(--primary-color); color: var(--white-color); border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-size: 15px; font-weight: 600; transition: background-color 0.2s, transform 0.1s; }
        button:hover { background-color: var(--hover-primary); transform: translateY(-1px); }
        .success-btn { background-color: var(--success-color); }
        .success-btn:hover { background-color: var(--hover-success); }
        .error-btn { background-color: var(--error-color); }
        .error-btn:hover { background-color: var(--hover-error); }
        .secondary-btn { background-color: var(--secondary-color); }
        .secondary-btn:hover { background-color: #5a6268; }
        #exportExcelBtn { background-color: #17a2b8; } #exportExcelBtn:hover { background-color: #107f91; }
        .table-container { overflow-x: auto; max-height: 450px; border: 1px solid var(--border-color); border-radius: 5px;}
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px 16px; border: 1px solid var(--border-color); text-align: left; }
        thead { background-color: #f4f5f7; color: var(--text-color); position: sticky; top: 0; z-index: 10; }
        th { font-weight: 600; }
        tbody tr:nth-child(even) { background-color: #fafbfc; }
        tbody tr:hover { background-color: #e9f2ff; }
        td[contenteditable="true"] { background-color: #fffae6; }
        .delete-btn { background-color: var(--error-color); padding: 5px 10px; font-size: 12px; }
        hr { border: 0; height: 1px; background-color: var(--border-color); margin: 40px 0; }
        #resultContainer { margin-top: 24px; }
        .result-section { margin-bottom: 20px; padding: 20px; border-radius: 5px; border-left: 5px solid; }
        .result-section h3 { margin-top: 0; font-size: 16px; }
        .correct { border-left-color: var(--success-color); background-color: #e3fcef; }
        .incorrect { border-left-color: var(--error-color); background-color: #ffebe6; }
        ul { padding-left: 20px; margin: 0;} li { margin-bottom: 8px; }
        .hidden { display: none !important; }
        #mappingSection, #mappingOrderSection { border: 2px solid var(--primary-color); border-radius: 8px; padding: 24px; margin-top: 24px; background: var(--white-color); }
        .mapping-row { display: flex; align-items: center; margin-bottom: 16px; gap: 12px;}
        .mapping-row label { flex-basis: 150px; text-align: right; font-weight: 600; }
        .mapping-row select, .mapping-row input { flex-grow: 1; }
        .mapping-actions { text-align: right; margin-top: 24px; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); align-items: center; justify-content: center; }
        .modal-content { background-color: #fefefe; margin: auto; padding: 32px; border: 1px solid #888; width: 90%; max-width: 800px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); position: relative; animation: fadeIn 0.3s; }
        .modal-content h3 { color: var(--primary-color); margin-top: 0; border-bottom: 1px solid #eee; padding-bottom: 16px; }
        .modal-content ul { list-style-type: disc; } .modal-content ol { padding-left: 24px; }
        .close-btn { color: #aaa; position: absolute; top: 12px; right: 20px; font-size: 32px; font-weight: bold; cursor: pointer; }
        .close-btn:hover, .close-btn:focus { color: black; }
        .modal-show { display: flex; }
        #helpBtn { position: absolute; top: 32px; right: 32px; background-color: #ffab00; font-size: 14px; padding: 8px 16px; z-index: 5; }
        #helpBtn:hover { background-color: #ff9900; }
        @keyframes fadeIn { from {opacity: 0; transform: scale(0.95);} to {opacity: 1; transform: scale(1);} }
        .auto-check-info { background: #d1ecf1; border: 1px solid #bee5eb; padding: 10px; border-radius: 4px; margin: 10px 0; }
        .checking-animation { display: inline-block; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body>
    <div class="container">
        <button id="helpBtn">‚ùì H∆∞·ªõng D·∫´n</button>
        <h1>Tr√¨nh Ki·ªÉm Tra ƒê∆°n H√†ng Gi√° - IDECO</h1>
        
        <h2>Qu·∫£n l√Ω D·ªØ li·ªáu Chu·∫©n</h2>
        <div class="selector-wrapper">
            <label for="datasetSelector" class="label">B∆∞·ªõc 1: Ch·ªçn B·∫£ng D·ªØ Li·ªáu (N·∫øu ƒë√£ c√≥)</label>
            <select id="datasetSelector">
                <option value="">-- Vui l√≤ng ch·ªçn --</option>
            </select>
        </div>
        <div class="controls">
            <label for="uploadMaster" class="file-upload">
                <span>üìÇ Ho·∫∑c T·∫£i L√™n B·∫£ng D·ªØ Li·ªáu M·ªõi</span>
                <input type="file" id="uploadMaster" accept=".xlsx, .xls, .csv">
            </label>
        </div>

        <div id="mappingSection" class="hidden">
            <h3>B∆∞·ªõc 2: √Ånh x·∫° c·ªôt</h3>
             <div class="mapping-row"><label for="mapMaSP">C·ªôt M√£ SP (*):</label><select id="mapMaSP"></select></div>
             <div class="mapping-row"><label for="mapTenSP">C·ªôt T√™n s·∫£n ph·∫©m (*):</label><select id="mapTenSP"></select></div>
             <div class="mapping-row"><label for="mapGia">C·ªôt Gi√° (*):</label><select id="mapGia"></select></div>
             <hr>
             <div class="mapping-row"><label for="mapSTT">C·ªôt STT (T√πy ch·ªçn):</label><select id="mapSTT"></select></div>
             <div class="mapping-row"><label for="mapDVT">C·ªôt ƒêVT (T√πy ch·ªçn):</label><select id="mapDVT"></select></div>
             <div class="mapping-row"><label for="mapCK">C·ªôt Chi·∫øt kh·∫•u (%) (T√πy ch·ªçn):</label><select id="mapCK"></select></div>
             <div class="mapping-row"><label for="datasetNameInput">ƒê·∫∑t t√™n b·∫£ng d·ªØ li·ªáu (*):</label><input type="text" id="datasetNameInput" placeholder="VD: B·∫£ng gi√° s·ªâ T10/2025"></div>
             <div class="mapping-actions">
                 <button id="confirmMappingBtn" class="success-btn">X√°c Nh·∫≠n & L∆∞u</button>
                 <button id="cancelMappingBtn" class="secondary-btn">H·ªßy</button>
            </div>
        </div>

        <div class="table-actions">
            <button id="addRowBtn">‚ûï Th√™m H√†ng</button>
            <button id="saveToFirebaseBtn" class="success-btn">üíæ L∆∞u Thay ƒê·ªïi</button>
            <button id="exportHDBtn" class="success-btn">üöÄ Xu·∫•t HD</button>
            <button id="exportExcelBtn">üìÑ Xu·∫•t Excel</button>
            <button id="clearDataBtn" class="error-btn">üóëÔ∏è X√≥a B·∫£ng N√†y</button>
        </div>
        <div class="table-container">
            <table id="dataTable">
                <thead>
                    <tr>
                        <th>STT</th>
                        <th>M√£ SP</th>
                        <th>T√™n s·∫£n ph·∫©m</th>
                        <th>ƒêVT</th>
                        <th>Gi√° xu·∫•t Hƒê (sau VAT)</th>
                        <th>Chi·∫øt kh·∫•u (%)</th>
                        <th>Quy c√°ch</th>
                        <th>H√†nh ƒë·ªông</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <hr>

        <h2>Ki·ªÉm Tra ƒê∆°n H√†ng</h2>
         <div class="selector-wrapper">
             <label class="label">ƒê·ªëi chi·∫øu v·ªõi b·∫£ng: "<b id="currentDatasetName" style="color:var(--primary-color)">...</b>"</label>
        </div>
        
        <div class="auto-check-info">
            <strong>üîç KI·ªÇM TRA TH√îNG MINH:</strong> ·ª®ng d·ª•ng s·∫Ω t·ª± ƒë·ªông d√≤ theo M√£ SP v√† T√™n s·∫£n ph·∫©m ƒë·ªÉ ki·ªÉm tra:
            <ul>
                <li>‚úÖ <strong>Gi√° xu·∫•t Hƒê:</strong> So s√°nh ch√≠nh x√°c gi√° trong ƒë∆°n h√†ng v·ªõi b·∫£ng d·ªØ li·ªáu chu·∫©n</li>
                <li>‚úÖ <strong>Chi·∫øt kh·∫•u:</strong> Ki·ªÉm tra % chi·∫øt kh·∫•u n·∫øu c√≥ trong ƒë∆°n h√†ng</li>
                <li>üéØ <strong>T·ª± ƒë·ªông nh·∫≠n di·ªán:</strong> D·ª±a v√†o √°nh x·∫° c·ªôt b·∫°n ch·ªçn ƒë·ªÉ ki·ªÉm tra k·ªπ l∆∞·ª°ng t·ª´ng s·∫£n ph·∫©m</li>
            </ul>
        </div>

        <div class="controls">
             <label for="uploadOrder" class="file-upload">
                <span>üìÇ T·∫£i l√™n file ƒê∆°n H√†ng</span>
                <input type="file" id="uploadOrder" accept=".xlsx, .xls, .csv">
            </label>
        </div>

        <div id="mappingOrderSection" class="hidden">
             <h3>B∆∞·ªõc 2: √Ånh x·∫° c·ªôt cho file ƒê∆°n H√†ng</h3>
             <div class="mapping-row"><label for="mapOrderMaSP">C·ªôt M√£ SP (*):</label><select id="mapOrderMaSP"></select></div>
             <div class="mapping-row"><label for="mapOrderTenSP">C·ªôt T√™n s·∫£n ph·∫©m (*):</label><select id="mapOrderTenSP"></select></div>
             <div class="mapping-row"><label for="mapOrderGia">C·ªôt Gi√° (*):</label><select id="mapOrderGia"></select></div>
             <div class="mapping-row"><label for="mapOrderCK">C·ªôt Chi·∫øt kh·∫•u (%) (T√πy ch·ªçn):</label><select id="mapOrderCK"></select></div>
             <div class="mapping-actions">
                 <button id="confirmOrderMappingBtn" class="success-btn">X√°c Nh·∫≠n & Ki·ªÉm Tra</button>
                 <button id="cancelOrderMappingBtn" class="secondary-btn">H·ªßy</button>
            </div>
        </div>
        
        <div id="resultContainer" class="hidden">
            <h2>K·∫øt Qu·∫£ Ki·ªÉm Tra <span id="checkingStatus"></span></h2>
            <div id="results"></div>
        </div>
    </div>
    
    <div id="helpModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" id="closeHelpModal">&times;</span>
           <h3>H∆∞·ªõng D·∫´n S·ª≠ D·ª•ng</h3>
            <h4>1. Qu·∫£n l√Ω D·ªØ Li·ªáu G·ªëc</h4>
            <ul>
                <li><strong>T·∫£i L√™n B·∫£ng D·ªØ Li·ªáu M·ªõi:</strong>
                    <ol>
                        <li>Nh·∫•n v√†o √¥ "T·∫£i l√™n file Excel m·ªõi" v√† ch·ªçn file c·ªßa b·∫°n.</li>
                        <li>M·ªôt khu v·ª±c <strong>"Tham chi·∫øu c·ªôt "</strong> s·∫Ω hi·ªán ra ngay tr√™n trang.</li>
                        <li>V·ªõi m·ªói d√≤ng c√≥ d·∫•u sao (*), h√£y ch·ªçn t·ª´ menu th·∫£ xu·ªëng t√™n c·ªôt t∆∞∆°ng ·ª©ng c√≥ trong file c·ªßa b·∫°n.</li>
                        <li>Nh·∫≠p t√™n cho b·∫£ng d·ªØ li·ªáu m·ªõi v√† nh·∫•n "X√°c Nh·∫≠n & L∆∞u".</li>
                    </ol>
                </li>
            </ul>
             <h4>2. Ki·ªÉm Tra ƒê∆°n H√†ng</h4>
            <ul>
                 <li><strong>B∆∞·ªõc 1:</strong> Ch·ªçn b·∫£ng d·ªØ li·ªáu chu·∫©n ƒë·ªÉ ƒë·ªëi chi·∫øu</li>
                 <li><strong>B∆∞·ªõc 2:</strong> T·∫£i file ƒë∆°n h√†ng v√† √°nh x·∫° c·ªôt ch√≠nh x√°c</li>
                 <li><strong>B∆∞·ªõc 3:</strong> ·ª®ng d·ª•ng s·∫Ω <strong>T·ª∞ ƒê·ªòNG KI·ªÇM TRA K·ª∏ L∆Ø·ª†NG</strong>:
                     <ul>
                         <li>So s√°nh gi√° theo M√£ SP v√† T√™n s·∫£n ph·∫©m</li>
                         <li>Ki·ªÉm tra chi·∫øt kh·∫•u n·∫øu c√≥ trong ƒë∆°n h√†ng</li>
                         <li>B√°o k·∫øt qu·∫£ chi ti·∫øt: ƒê√öNG/SAI cho t·ª´ng s·∫£n ph·∫©m</li>
                     </ul>
                 </li>
            </ul>
        </div>
    </div>
    
    <div id="hdModal" class="modal">
        <div class="modal-content" style="max-width: 1000px;"> <span class="close-btn" id="closeHdModal">&times;</span>
            <h3>B·∫£ng Gi√° B√°n ƒê∆°n V·ªã (Xu·∫•t HD)</h3>
            <div class="table-container" style="max-height: 500px;"> <table id="hdTable" style="width: 100%;">
                    <thead>
                        <tr>
                            <th>M√£</th>
                            <th>T√™n s·∫£n ph·∫©m</th>
                            <th>Quy c√°ch</th>
                            <th>Gi√° b√°n ƒë∆°n v·ªã</th>
                        </tr>
                    </thead>
                    <tbody id="hdTableBody">
                        </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDtxpm3ZGde1Zl0BtTalGAsY9XFGQyncjQ",
            authDomain: "kiemtradon.firebaseapp.com",
            databaseURL: "https://kiemtradon-default-rtdb.firebaseio.com",
            projectId: "kiemtradon",
            storageBucket: "kiemtradon.firebasestorage.app",
            messagingSenderId: "113183972853",
            appId: "1:113183972853:web:5ecbd594ef8a5154d214bc",
            measurementId: "G-N59VCM3QJF"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const masterDataRef = database.ref('du_lieu_goc');

        let tempJsonData = null;
        let currentMasterData = null;

        const datasetSelector = document.getElementById('datasetSelector');
        const currentDatasetNameSpan = document.getElementById('currentDatasetName');
        const uploadMasterInput = document.getElementById('uploadMaster');
        const dataTableBody = document.querySelector('#dataTable tbody');
        const addRowBtn = document.getElementById('addRowBtn');
        const saveToFirebaseBtn = document.getElementById('saveToFirebaseBtn');
        const exportHDBtn = document.getElementById('exportHDBtn'); 
        const exportExcelBtn = document.getElementById('exportExcelBtn');
        const clearDataBtn = document.getElementById('clearDataBtn');
        const uploadOrderInput = document.getElementById('uploadOrder');
        const resultsDiv = document.getElementById('results');
        const resultContainer = document.getElementById('resultContainer');
        const checkingStatus = document.getElementById('checkingStatus');
        
        const mappingSection = document.getElementById('mappingSection');
        const confirmMappingBtn = document.getElementById('confirmMappingBtn');
        const cancelMappingBtn = document.getElementById('cancelMappingBtn');

        const mappingOrderSection = document.getElementById('mappingOrderSection');
        const confirmOrderMappingBtn = document.getElementById('confirmOrderMappingBtn');
        const cancelOrderMappingBtn = document.getElementById('cancelOrderMappingBtn');
        
        const helpBtn = document.getElementById('helpBtn');
        const helpModal = document.getElementById('helpModal');
        const closeHelpModal = document.getElementById('closeHelpModal');
        
        const hdModal = document.getElementById('hdModal');
        const closeHdModal = document.getElementById('closeHdModal');
        const hdTableBody = document.getElementById('hdTableBody');

        helpBtn.onclick = () => helpModal.classList.add('modal-show');
        closeHelpModal.onclick = () => helpModal.classList.remove('modal-show');
        closeHdModal.onclick = () => hdModal.classList.remove('modal-show');
        
        window.onclick = (event) => { 
            if (event.target == helpModal) helpModal.classList.remove('modal-show');
            if (event.target == hdModal) hdModal.classList.remove('modal-show');
        };

        function showCheckingStatus(message) {
            checkingStatus.innerHTML = `<span class="checking-animation">${message}</span>`;
        }

        function hideCheckingStatus() {
            checkingStatus.innerHTML = '';
        }

        function getCKValue(row, mappingKey) {
            if (!mappingKey || !row[mappingKey]) return 0;
            let val = row[mappingKey];
            if (val === undefined || val === null || val === '') return 0;
            
            let num = parseFloat(String(val).replace(/[%,]/g, ''));
            if (isNaN(num)) return 0;
            
            if (num < 1 && num > 0) {
                return num * 100;
            }
            return num;
        }

        function getSelectedDatasetKey() { return datasetSelector.value; }

        function populateDatasetSelector() {
            masterDataRef.once('value', snapshot => {
                const datasets = snapshot.val();
                const currentKey = getSelectedDatasetKey();
                datasetSelector.innerHTML = '<option value="">-- Vui l√≤ng ch·ªçn --</option>';
                if (datasets) {
                    Object.keys(datasets).forEach(key => {
                        const option = new Option(key, key);
                        datasetSelector.appendChild(option);
                    });
                    if (currentKey) datasetSelector.value = currentKey;
                }
            });
        }
        
        datasetSelector.addEventListener('change', () => {
            loadDataFromFirebase();
            currentDatasetNameSpan.textContent = getSelectedDatasetKey() || '...';
        });
        
        function loadDataFromFirebase() {
            const datasetKey = getSelectedDatasetKey();
            dataTableBody.innerHTML = '';
            if (!datasetKey) {
                dataTableBody.innerHTML = '<tr><td colspan="8">Vui l√≤ng ch·ªçn m·ªôt b·∫£ng d·ªØ li·ªáu ƒë·ªÉ xem.</td></tr>';
                currentMasterData = null;
                return;
            }
            dataTableBody.innerHTML = `<tr><td colspan="8">ƒêang t·∫£i d·ªØ li·ªáu t·ª´ b·∫£ng "${datasetKey}"...</td></tr>`;
            masterDataRef.child(datasetKey).once('value', snapshot => {
                const data = snapshot.val();
                currentMasterData = data;
                dataTableBody.innerHTML = '';
                if (data && Array.isArray(data)) {
                    data.forEach(item => dataTableBody.appendChild(createTableRow(item)));
                } else {
                    dataTableBody.innerHTML = `<tr><td colspan="8">B·∫£ng d·ªØ li·ªáu "${datasetKey}" kh√¥ng c√≥ d·ªØ li·ªáu.</td></tr>`;
                }
            });
        }

        function setupMappingUI(file, section, selects) {
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const data = new Uint8Array(event.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                    const headers = XLSX.utils.sheet_to_json(worksheet, { header: 1 })[0] || [];
                    tempJsonData = XLSX.utils.sheet_to_json(worksheet);

                    if (tempJsonData.length === 0) throw new Error("File kh√¥ng c√≥ d·ªØ li·ªáu.");

                    Object.values(selects).forEach(sel => sel.innerHTML = '');

                    const noneOption = '<option value="">-- B·ªè qua --</option>';
                    headers.forEach(header => {
                        const option = `<option value="${header}">${header}</option>`;
                        Object.values(selects).forEach(sel => sel.innerHTML += option);
                    });
                    
                    if (selects.mapSTT) selects.mapSTT.innerHTML = noneOption + selects.mapSTT.innerHTML;
                    if (selects.mapDVT) selects.mapDVT.innerHTML = noneOption + selects.mapDVT.innerHTML;
                    if (selects.mapCK) selects.mapCK.innerHTML = noneOption + selects.mapCK.innerHTML;
                    if (selects.mapOrderCK) selects.mapOrderCK.innerHTML = noneOption + selects.mapOrderCK.innerHTML;

                    section.classList.remove('hidden');
                } catch (err) { 
                    alert("L·ªói khi ƒë·ªçc file: " + err.message); 
                }
            };
            reader.readAsArrayBuffer(file);
        }

        uploadMasterInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;
            document.getElementById('datasetNameInput').value = file.name.replace(/\.[^/.]+$/, "");
            setupMappingUI(file, mappingSection, {
                mapMaSP: document.getElementById('mapMaSP'),
                mapTenSP: document.getElementById('mapTenSP'),
                mapGia: document.getElementById('mapGia'),
                mapSTT: document.getElementById('mapSTT'),
                mapDVT: document.getElementById('mapDVT'),
                mapCK: document.getElementById('mapCK')
            });
            event.target.value = '';
        });

        cancelMappingBtn.addEventListener('click', () => {
            mappingSection.classList.add('hidden');
            tempJsonData = null;
        });

        confirmMappingBtn.addEventListener('click', () => {
            try {
                const mapping = {
                    ma_sp: document.getElementById('mapMaSP').value,
                    ten_sp: document.getElementById('mapTenSP').value,
                    gia_xuat: document.getElementById('mapGia').value,
                    stt: document.getElementById('mapSTT').value,
                    dvt: document.getElementById('mapDVT').value,
                    chiet_khau: document.getElementById('mapCK').value,
                    datasetName: document.getElementById('datasetNameInput').value.trim()
                };

                if (!mapping.ma_sp || !mapping.ten_sp || !mapping.gia_xuat || !mapping.datasetName) throw new Error("Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß c√°c tr∆∞·ªùng b·∫Øt bu·ªôc (*).");
                if (!tempJsonData) throw new Error("Kh√¥ng c√≥ d·ªØ li·ªáu file t·∫°m th·ªùi. Vui l√≤ng th·ª≠ l·∫°i.");

                const dataToSave = tempJsonData.map((row, index) => ({
                    stt: (mapping.stt ? row[mapping.stt] : (index + 1)) || (index + 1),
                    ma_sp: String(row[mapping.ma_sp] || '').trim(),
                    ten_sp: String(row[mapping.ten_sp] || '').trim(),
                    dvt: (mapping.dvt ? String(row[mapping.dvt] || '') : ''),
                    gia_xuat: parseFloat(row[mapping.gia_xuat]) || 0,
                    chiet_khau: getCKValue(row, mapping.chiet_khau),
                    quy_cach: 1 
                }));

                masterDataRef.child(mapping.datasetName).set(dataToSave).then(() => {
                    alert(`ƒê√£ l∆∞u th√†nh c√¥ng b·∫£ng d·ªØ li·ªáu "${mapping.datasetName}"!`);
                    populateDatasetSelector();
                    datasetSelector.value = mapping.datasetName;
                    loadDataFromFirebase();
                    cancelMappingBtn.click();
                }).catch(err => { throw new Error("L·ªói khi l∆∞u v√†o Firebase: " + err.message); });

            } catch(error) { 
                alert("ƒê√£ c√≥ l·ªói x·∫£y ra: " + error.message); 
            }
        });

        uploadOrderInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;
            if (!getSelectedDatasetKey()) {
                alert("Vui l√≤ng ch·ªçn B·∫£ng D·ªØ Li·ªáu Chu·∫©n ƒë·ªÉ ƒë·ªëi chi·∫øu tr∆∞·ªõc!");
                event.target.value = '';
                return;
            }
            setupMappingUI(file, mappingOrderSection, {
                mapOrderMaSP: document.getElementById('mapOrderMaSP'),
                mapOrderTenSP: document.getElementById('mapOrderTenSP'),
                mapOrderGia: document.getElementById('mapOrderGia'),
                mapOrderCK: document.getElementById('mapOrderCK')
            });
            event.target.value = '';
        });

        cancelOrderMappingBtn.addEventListener('click', () => {
            mappingOrderSection.classList.add('hidden');
            tempJsonData = null;
        });

        confirmOrderMappingBtn.addEventListener('click', () => {
            try {
                const mapping = {
                    ma_sp: document.getElementById('mapOrderMaSP').value,
                    ten_sp: document.getElementById('mapOrderTenSP').value,
                    gia_xuat: document.getElementById('mapOrderGia').value,
                    chiet_khau: document.getElementById('mapOrderCK').value
                };

                if (!mapping.ma_sp || !mapping.ten_sp || !mapping.gia_xuat) throw new Error("Vui l√≤ng √°nh x·∫° ƒë·∫ßy ƒë·ªß c√°c c·ªôt b·∫Øt bu·ªôc (*).");
                if (!tempJsonData) throw new Error("Kh√¥ng c√≥ d·ªØ li·ªáu file t·∫°m th·ªùi. Vui l√≤ng th·ª≠ l·∫°i.");

                const datasetKey = getSelectedDatasetKey();
                
                showCheckingStatus("üîÑ ƒêang ki·ªÉm tra...");
                resultContainer.classList.remove('hidden');

                if (!currentMasterData) {
                    masterDataRef.child(datasetKey).once('value', snapshot => {
                        currentMasterData = snapshot.val();
                        performOrderCheck(mapping, datasetKey);
                    });
                } else {
                    performOrderCheck(mapping, datasetKey);
                }

            } catch (error) { 
                alert("ƒê√£ c√≥ l·ªói x·∫£y ra: " + error.message); 
                hideCheckingStatus();
            }
        });

        function performOrderCheck(mapping, datasetKey) {
            if (!currentMasterData) {
                alert(`B·∫£ng d·ªØ li·ªáu "${datasetKey}" kh√¥ng c√≥ d·ªØ li·ªáu.`);
                hideCheckingStatus();
                return;
            }

            // T·∫°o map t·ª´ d·ªØ li·ªáu master ƒë·ªÉ d·ªÖ d√†ng tra c·ª©u
            const masterDataMap = new Map();
            currentMasterData.forEach(item => { 
                if (item.ma_sp) {
                    const maSP = String(item.ma_sp).trim().toLowerCase();
                    const tenSP = String(item.ten_sp || '').trim().toLowerCase();
                    const key = `${maSP}_${tenSP}`;
                    masterDataMap.set(key, item);
                }
            });

            const correctItems = [], incorrectItems = [];
            let totalChecked = 0;
            
            tempJsonData.forEach((orderItem, index) => {
                const orderMaSP = String(orderItem[mapping.ma_sp] || '').trim();
                const orderTenSP = String(orderItem[mapping.ten_sp] || '').trim();
                
                if (!orderMaSP) {
                    return;
                }
                
                totalChecked++;
                
                const orderGiaXuat = parseFloat(orderItem[mapping.gia_xuat]) || 0;
                const orderChietKhau = getCKValue(orderItem, mapping.chiet_khau);

                // T√¨m s·∫£n ph·∫©m trong master theo m√£ v√† t√™n
                const searchKey = `${orderMaSP.toLowerCase()}_${orderTenSP.toLowerCase()}`;
                let masterItem = masterDataMap.get(searchKey);
                
                // N·∫øu kh√¥ng t√¨m th·∫•y theo c·∫£ m√£ v√† t√™n, th·ª≠ t√¨m ch·ªâ theo m√£
                if (!masterItem) {
                    for (let [key, item] of masterDataMap) {
                        if (key.startsWith(orderMaSP.toLowerCase() + '_')) {
                            masterItem = item;
                            break;
                        }
                    }
                }

                if (masterItem) {
                    const masterGia = parseFloat(masterItem.gia_xuat || 0);
                    const masterCK = parseFloat(masterItem.chiet_khau || 0);
                    const masterTenSP = masterItem.ten_sp;

                    // Ki·ªÉm tra gi√°
                    const giaKhop = Math.abs(orderGiaXuat - masterGia) < 100;
                    
                    // Ki·ªÉm tra chi·∫øt kh·∫•u (n·∫øu c√≥ trong ƒë∆°n h√†ng)
                    let ckKhop = true;
                    let hasCKInOrder = mapping.chiet_khau && orderChietKhau > 0;
                    if (hasCKInOrder) {
                        ckKhop = Math.abs(orderChietKhau - masterCK) < 0.1;
                    }

                    if (giaKhop && ckKhop) {
                        let msg = `<li><b>${orderMaSP} - ${masterTenSP}</b>: `;
                        msg += `‚úÖ <strong>GI√Å ƒê√öNG</strong> (${orderGiaXuat.toLocaleString('vi-VN')} VNƒê)`;
                        if (hasCKInOrder) {
                            msg += ` & ‚úÖ <strong>CHI·∫æT KH·∫§U ƒê√öNG</strong> (${orderChietKhau.toLocaleString('vi-VN')}%)`;
                        }
                        msg += `</li>`;
                        correctItems.push(msg);
                    } else {
                        let errorMsg = `<li><b>${orderMaSP} - ${masterTenSP}</b>: `;
                        let errors = [];
                        
                        if (!giaKhop) {
                            errors.push(`‚ùå <strong style="color:var(--error-color);">SAI GI√Å</strong> (ƒêH: ${orderGiaXuat.toLocaleString('vi-VN')} ƒë vs G·ªëc: ${masterGia.toLocaleString('vi-VN')} ƒë)`);
                        }
                        
                        if (hasCKInOrder && !ckKhop) {
                            errors.push(`‚ùå <strong style="color:var(--error-color);">SAI CHI·∫æT KH·∫§U</strong> (ƒêH: ${orderChietKhau.toLocaleString('vi-VN')}% vs G·ªëc: ${masterCK.toLocaleString('vi-VN')}%)`);
                        }
                        
                        errorMsg += errors.join(' | ') + `</li>`;
                        incorrectItems.push(errorMsg);
                    }
                } else {
                    incorrectItems.push(`<li><b>${orderMaSP} - ${orderTenSP}</b>: ‚ùå <strong style="color:var(--error-color);">KH√îNG T√åM TH·∫§Y</strong> trong b·∫£ng d·ªØ li·ªáu.</li>`);
                }
            });

            displayResults(correctItems, incorrectItems, totalChecked);
            cancelOrderMappingBtn.click();
            hideCheckingStatus();
        }
        
        function displayResults(correct, incorrect, totalChecked) {
            const correctCount = correct.length;
            const incorrectCount = incorrect.length;
            
            let resultsHTML = `
                <div class="result-section correct">
                    <h3 style="color: var(--success-color);">‚úÖ ƒê√öNG (${correctCount}/${totalChecked})</h3>
                    <ul>${correct.length>0 ? correct.join('') : '<li>Kh√¥ng c√≥ s·∫£n ph·∫©m n√†o ƒë√∫ng.</li>'}</ul>
                </div>
                <div class="result-section incorrect">
                    <h3 style="color: var(--error-color);">‚ùå SAI / KH√îNG T√åM TH·∫§Y (${incorrectCount}/${totalChecked})</h3>
                    <ul>${incorrect.length>0 ? incorrect.join('') : '<li>Kh√¥ng c√≥ s·∫£n ph·∫©m n√†o sai.</li>'}</ul>
                </div>
            `;
            
            resultsDiv.innerHTML = resultsHTML;
        }
        
        clearDataBtn.addEventListener('click', () => {
            const datasetKey = getSelectedDatasetKey();
            if (!datasetKey) { alert("Vui l√≤ng ch·ªçn m·ªôt b·∫£ng d·ªØ li·ªáu ƒë·ªÉ x√≥a."); return; }
            if (confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën X√ìA Vƒ®NH VI·ªÑN b·∫£ng d·ªØ li·ªáu "${datasetKey}" kh√¥ng?`)) {
                masterDataRef.child(datasetKey).remove().then(() => {
                    alert(`ƒê√£ x√≥a th√†nh c√¥ng b·∫£ng d·ªØ li·ªáu "${datasetKey}".`);
                    populateDatasetSelector();
                    loadDataFromFirebase();
                });
            }
        });

        saveToFirebaseBtn.addEventListener('click', () => {
            const datasetKey = getSelectedDatasetKey();
            if (!datasetKey) { alert("Vui l√≤ng ch·ªçn m·ªôt b·∫£ng d·ªØ li·ªáu ƒë·ªÉ l∆∞u."); return; }
            
            const rows = dataTableBody.querySelectorAll('tr');
            const dataToSave = Array.from(rows).map(row => {
                const cells = row.querySelectorAll('td');
                return {
                    stt: cells[0].innerText, 
                    ma_sp: cells[1].innerText, 
                    ten_sp: cells[2].innerText,
                    dvt: cells[3].innerText, 
                    gia_xuat: parseFloat(cells[4].innerText.replace(/[.,]/g, '')) || 0,
                    chiet_khau: parseFloat(cells[5].innerText.replace(/[.,%]/g, '')) || 0,
                    quy_cach: parseInt(cells[6].innerText.replace(/[.,]/g, '')) || 1 
                };
            });
            masterDataRef.child(datasetKey).set(dataToSave).then(() => {
                alert(`L∆∞u thay ƒë·ªïi cho b·∫£ng "${datasetKey}" th√†nh c√¥ng!`);
            });
        });
        
        exportHDBtn.addEventListener('click', () => {
            const datasetKey = getSelectedDatasetKey();
            if (!datasetKey) { alert("Vui l√≤ng ch·ªçn b·∫£ng d·ªØ li·ªáu ƒë·ªÉ xu·∫•t HD."); return; }
            const rows = dataTableBody.querySelectorAll('tr');
            
            if (rows.length === 0 || dataTableBody.querySelector('td[colspan="8"]')) { alert("Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ t√≠nh to√°n!"); return; }

            let htmlRows = "";

            Array.from(rows).forEach(row => {
                const cells = row.querySelectorAll('td');
                try {
                    const ma_sp = cells[1].innerText;
                    const ten_sp = cells[2].innerText;
                    const gia_goc = parseFloat(cells[4].innerText.replace(/[.,]/g, '')) || 0;
                    const chiet_khau_percent = parseFloat(cells[5].innerText.replace(/[.,%]/g, '')) || 0;
                    const quy_cach = parseInt(cells[6].innerText.replace(/[.,]/g, '')) || 1;

                    if (quy_cach === 0) return;

                    let gia_ban_don_vi = 0;
                    
                    if (chiet_khau_percent > 0) {
                        const gia_sau_ck = gia_goc * (1 - (chiet_khau_percent / 100));
                        gia_ban_don_vi = (gia_sau_ck / quy_cach) / 1.05;
                    } else {
                        gia_ban_don_vi = (gia_goc / quy_cach) / 1.05;
                    }

                    const gia_ban_don_vi_lam_tron = Math.round(gia_ban_don_vi);

                    htmlRows += `
                        <tr>
                            <td>${ma_sp}</td>
                            <td>${ten_sp}</td>
                            <td style="text-align: right;">${quy_cach.toLocaleString('vi-VN')}</td>
                            <td style="text-align: right; font-weight: 600; color: var(--error-color);">${gia_ban_don_vi_lam_tron.toLocaleString('vi-VN')}</td>
                        </tr>
                    `;
                } catch (e) {
                    console.error("L·ªói khi x·ª≠ l√Ω h√†ng: ", row, e);
                }
            });

            hdTableBody.innerHTML = htmlRows;
            hdModal.classList.add('modal-show');
        });

        addRowBtn.addEventListener('click', () => {
            if (!getSelectedDatasetKey()) { alert("Vui l√≤ng ch·ªçn m·ªôt b·∫£ng d·ªØ li·ªáu tr∆∞·ªõc khi th√™m h√†ng."); return; }
            dataTableBody.appendChild(createTableRow({ stt: dataTableBody.rows.length + 1 }, true));
        });

        exportExcelBtn.addEventListener('click', () => {
            const datasetKey = getSelectedDatasetKey();
            if (!datasetKey) { alert("Vui l√≤ng ch·ªçn b·∫£ng d·ªØ li·ªáu ƒë·ªÉ xu·∫•t."); return; }
            const rows = dataTableBody.querySelectorAll('tr');
            if (rows.length === 0 || dataTableBody.querySelector('td[colspan="8"]')) { alert("Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t!"); return; }
            const data = Array.from(rows).map(row => {
                const cells = row.querySelectorAll('td');
                return { 
                    'STT': cells[0].innerText, 
                    'M√£ SP': cells[1].innerText, 
                    'T√™n s·∫£n ph·∫©m': cells[2].innerText, 
                    'ƒêVT': cells[3].innerText, 
                    'Gi√° xu·∫•t Hƒê (sau VAT)': cells[4].innerText,
                    'Chi·∫øt kh·∫•u (%)': cells[5].innerText,
                    'Quy c√°ch': cells[6].innerText 
                };
            });
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, datasetKey);
            XLSX.writeFile(wb, `${datasetKey}.xlsx`);
        });

        function createTableRow(item, isNew = false) {
            const row = document.createElement('tr');
            row.innerHTML = `<td contenteditable="${isNew}">${item.stt||''}</td><td contenteditable="true">${item.ma_sp||''}</td><td contenteditable="true">${item.ten_sp||''}</td><td contenteditable="true">${item.dvt||''}</td><td contenteditable="true">${item.gia_xuat!=null?Number(item.gia_xuat).toLocaleString('vi-VN'):''}</td><td contenteditable="true">${item.chiet_khau!=null?Number(item.chiet_khau).toLocaleString('vi-VN') + '%':''}</td><td contenteditable="true">${item.quy_cach || '1'}</td><td><button class="delete-btn">X√≥a</button></td>`;
            row.querySelector('.delete-btn').addEventListener('click', () => row.remove());
            return row;
        }

        document.addEventListener('DOMContentLoaded', () => {
            populateDatasetSelector();
        });
    </script>
</body>
</html>
